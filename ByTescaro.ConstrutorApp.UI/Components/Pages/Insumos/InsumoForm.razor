@page "/insumo/novo"
@page "/insumo/editar/{Id:long}"

@using ByTescaro.ConstrutorApp.Application.DTOs
@using ByTescaro.ConstrutorApp.Domain.Enums
@using ByTescaro.ConstrutorApp.UI.Services
@using Microsoft.AspNetCore.Authorization
@using System.Globalization
@using System.Reflection
@using System.ComponentModel.DataAnnotations
@inject InsumoApiService InsumoApiService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@attribute [Authorize]

<PageTitle>Insumo</PageTitle>

<RadzenCard Class="rz-mt-5 rz-p-4 rz-shadow-md rz-rounded-md rz-mx-auto" Style="max-width: 1300px; width: 100%;">
    <RadzenTemplateForm TItem="InsumoDto" Data="@insumo" Submit="Salvar" InvalidSubmit="ExibirErros">
        <RadzenHeading Size="H4" Text="@(Id == 0 ? "Novo Insumo" : "Editar Insumo")" Class="rz-mb-3" />

        <!-- Identificação -->
        <RadzenFieldset Text="Identificação" Style="margin-bottom: 1.5rem;">
            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenLabel Text="Nome" />
                    <RadzenTextBox @bind-Value="insumo.Nome" Name="Nome" Style="width: 100%;" />
                    <RadzenRequiredValidator Component="Nome" Text="O nome é obrigatório" />
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenLabel Text="Unidade de Medida" />
                    <RadzenDropDown @bind-Value="insumo.UnidadeMedida"
                                    TValue="UnidadeMedida?"
                                    Data="@UnidadeMedidaOptions"
                                    TextProperty="Label"
                                    ValueProperty="Value"
                                    Name="UnidadeMedida"
                                    Style="width: 100%;"/>
                    <RadzenRequiredValidator Component="UnidadeMedida" Text="Unidade de Medida é obrigatória" />
                </RadzenColumn>


                <RadzenColumn Size="12">
                    <RadzenLabel Text="Descrição" />
                    <RadzenTextBox @bind-Value="insumo.Descricao" Name="Descricao" Multiline="true" Rows="3" Style="width: 100%;" />
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenCheckBox @bind-Value="insumo.Ativo" Name="Ativo" />
                    <RadzenLabel Text="Insumo Ativo" />
                </RadzenColumn>
            </RadzenRow>
        </RadzenFieldset>

       
        <!-- Botões -->
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-3">
            <RadzenButton Text="Cancelar" ButtonStyle="ButtonStyle.Light" Click="@Cancelar" />
            <RadzenButton Text="Salvar" ButtonType="ButtonType.Submit" Icon="save" Style="min-width: 120px;" />
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenCard>

@code {
    [Parameter] public long Id { get; set; }

    private InsumoDto insumo = new();
    private readonly CultureInfo _br = CultureInfo.GetCultureInfo("pt-BR");
    private InsumoDto _originalInsumoDto = new();

    public class UnidadeMedidaOption
    {
        public UnidadeMedida? Value { get; set; }
        public string? Label { get; set; } = string.Empty;
    }

    private List<UnidadeMedidaOption> UnidadeMedidaOptions =>
    Enum.GetValues(typeof(UnidadeMedida))
        .Cast<UnidadeMedida>()
        .Select(e => new UnidadeMedidaOption
            {
                Value = e,
                Label = e.GetType()
                         .GetMember(e.ToString())
                         .FirstOrDefault()?
                         .GetCustomAttribute<DisplayAttribute>()?
                         .Name ?? e.ToString()
            })
            .OrderBy(x => x.Label)
            .Prepend(new UnidadeMedidaOption { Value = null, Label = "-- Selecione --" })
            .ToList();

    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            var existente = await InsumoApiService.GetByIdAsync(Id);
            if (existente is not null)
            {
                insumo = existente;
                _originalInsumoDto = existente.Clone(); 
            }
        }
    }

    private async Task<List<string>> ValidateInsumoForm(InsumoDto model)
    {
        var errors = new List<string>();

        // 1. Validação de Duplicidade do Nome
        if (!string.IsNullOrWhiteSpace(model.Nome))
        {
            string originalNome = _originalInsumoDto?.Nome ?? string.Empty;
            bool nomeChanged = (model.Id == 0) || (model.Nome != originalNome);

            if (nomeChanged)
            {
                long? ignoreId = model.Id != 0 ? model.Id : (long?)null;
                bool nomeAlreadyExists = await InsumoApiService.NomeExistsAsync(model.Nome, ignoreId);

                if (nomeAlreadyExists)
                {
                    errors.Add("Já existe um insumo com este nome.");
                }
            }
        }
        else
        {
            // RadzenRequiredValidator lida com nome obrigatório.
            // errors.Add("O nome do insumo é obrigatório."); // Descomente se quiser uma mensagem extra aqui.
        }

        // 2. Validação da Unidade de Medida
        if (!model.UnidadeMedida.HasValue)
        {
            errors.Add("A Unidade de Medida é obrigatória.");
        }

        return errors;
    }


    private async Task Salvar(InsumoDto model)
    {
        // Limpar strings (trim) se necessário, antes da validação
        model.Nome = model.Nome?.Trim() ?? string.Empty;
        model.Descricao = model.Descricao?.Trim() ?? string.Empty;

        // 1. Executa todas as validações customizadas
        var validationErrors = await ValidateInsumoForm(model);

        if (validationErrors.Any())
        {
            foreach (var error in validationErrors)
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Erro de Validação", Detail = error, Duration = 5000 });
            }
            return; // Impede a submissão se houver erros de validação
        }

        // Se todas as validações manuais passaram, tente salvar.
        try
        {
            if (model.Id == 0)
            {
                await InsumoApiService.CreateAsync(model);
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Sucesso",
                        Detail = "Insumo cadastrado com sucesso!",
                        Duration = 4000
                    });
            }
            else
            {
                await InsumoApiService.UpdateAsync(model);
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Sucesso",
                        Detail = "Insumo atualizado com sucesso!",
                        Duration = 4000
                    });
            }

            Navigation.NavigateTo("/insumos");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Erro",
                    Detail = $"Erro ao salvar insumo: {ex.Message}",
                    Duration = 5000
                });
        }
    }

    private void ExibirErros()
    {
        NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = "Atenção",
                Detail = "Existem erros de validação no formulário.",
                Duration = 4000
            });
    }

    private void Cancelar() => Navigation.NavigateTo("/insumos");
}
