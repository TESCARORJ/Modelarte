@using ByTescaro.ConstrutorApp.Application.DTOs
@using ByTescaro.ConstrutorApp.UI.Services // Alterado para o novo serviço de API
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ObraImagemApiService ObraImagemApiService // Injetado o novo serviço de API
@inject ObraApiService ObraApiService // Mantido para carregar a obra completa se necessário

<RadzenCard Variant="Variant.Outlined" Class="rz-pa-4">
    <RadzenHeading Size="H6" Text="Galeria de Fotos da Obra" />

    <RadzenUpload Accept=".jpg,.jpeg,.png,.bmp" Multiple="true" Change="@OnUpload" ChooseText="Selecionar Imagens"
                  InputAttributes="@(new Dictionary<string, object> { { "aria-label", "selecionar imagens" } })" />

    <RadzenDivider Class="rz-my-3" />

    @if (Obra.Imagens?.Any() == true)
    {
        <RadzenRow>
            @foreach (var img in Obra.Imagens)
            {
                <RadzenColumn Size="6" SizeSM="4" SizeMD="3" SizeLG="2">
                    <div style="position: relative;">
                        <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger"
                                      Style="position: absolute; top: 4px; right: 4px; z-index: 10;"
                                      Click="@(() => ConfirmarRemocao(img))" />

                        <div style="cursor:pointer;" @onclick="() => AbrirGaleria(img)">
                            <img src="/@img.CaminhoRelativo" alt="@img.NomeOriginal" style="width: 100%; height: 120px; object-fit: cover; border-radius: 5px;" />
                            <div class="rz-mt-1 rz-text-caption">@img.NomeOriginal</div>
                        </div>
                    </div>
                </RadzenColumn>
            }
        </RadzenRow>
    }
    else
    {
        <RadzenText Text="Nenhuma imagem adicionada." />
    }
</RadzenCard>

@code {
    [Parameter] public ObraDto Obra { get; set; } = new();

    protected override async Task OnParametersSetAsync()
    {
        // Garante que o Obra.Id seja válido antes de buscar os dados
        if (Obra != null && Obra.Id > 0)
        {
            // Carrega as imagens associadas a esta obra
            Obra.Imagens = await ObraImagemApiService.GetByObraIdAsync(Obra.Id);
            StateHasChanged();
        }
    }

    private async void OnUpload(UploadChangeEventArgs args)
    {
        if (Obra.Imagens == null)
            Obra.Imagens = new List<ObraImagemDto>();

        foreach (var file in args.Files)
        {
            try
            {
                var nomeOriginal = Path.GetFileName(file.Name);
                var extensao = Path.GetExtension(file.Name).ToLower();
                var nomeUnico = $"{Guid.NewGuid()}{extensao}";

                var pastaDestino = Path.Combine("wwwroot", "Uploads", "Projetos", Obra.ProjetoId.ToString(), Obra.Id.ToString(), "Imagens");
                Directory.CreateDirectory(pastaDestino);

                var caminhoFinal = Path.Combine(pastaDestino, nomeUnico);
                var stream = file.OpenReadStream(5_000_000); // Limite de 5MB
                await using var fs = File.Create(caminhoFinal);
                await stream.CopyToAsync(fs);
                await fs.FlushAsync();
                stream.Close();

                var caminhoRelativo = Path.Combine("Uploads", "Projetos", Obra.ProjetoId.ToString(), Obra.Id.ToString(), "Imagens", nomeUnico).Replace("\\", "/");
                var tamanhoKb = (long)(file.Size / 1024); // Use long para TamanhoEmKb

                var imagemDto = new ObraImagemDto
                {
                    ObraId = Obra.Id,
                    NomeOriginal = nomeOriginal,
                    CaminhoRelativo = caminhoRelativo,
                    TamanhoEmKb = tamanhoKb,
                    DataHoraCadastro = DateTime.Now,
                    // UsuarioCadastroId e UsuarioCadastroNome serão preenchidos no serviço.
                };

                // Chamar o serviço de API para criar o registro no banco de dados
                await ObraImagemApiService.CreateAsync(imagemDto);

                // O imagemDto agora deve ter o Id e UsuarioCadastroNome preenchidos pelo serviço
                Obra.Imagens.Add(imagemDto);

                NotificationService.Notify(NotificationSeverity.Success, "Imagem salva", $"Imagem '{nomeOriginal}' salva com sucesso.");
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Erro ao salvar", ex.Message);
            }
        }

        StateHasChanged();
    }

    private void AbrirGaleria(ObraImagemDto imagemSelecionada)
    {
        if (Obra.Imagens == null || !Obra.Imagens.Any())
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Aviso", "Não há imagens para exibir na galeria.");
            return;
        }

        var parametros = new Dictionary<string, object>
        {
            { "Imagens", new List<ObraImagemDto>(Obra.Imagens) },
            { "ImagemInicial", imagemSelecionada }
        };

        DialogService.Open<DialogGaleriaImagens>("Galeria de Fotos", parametros, new DialogOptions { Width = "90%", Height = "90%", ShowClose = true });
    }

    private async Task ConfirmarRemocao(ObraImagemDto imagem)
    {
        bool? confirm = await DialogService.Confirm($"Deseja realmente remover a imagem '{imagem.NomeOriginal}'?", "Remover Imagem");

        if (confirm == true)
        {
            try
            {
                // A remoção do arquivo físico e do registro no BD será feita pelo serviço
                await ObraImagemApiService.DeleteAsync(imagem.Id);

                Obra.Imagens.Remove(imagem);
                NotificationService.Notify(NotificationSeverity.Info, "Removida", $"Imagem '{imagem.NomeOriginal}' removida.");
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Erro", $"Erro ao excluir imagem: {ex.Message}");
            }

            StateHasChanged();
        }
    }
}